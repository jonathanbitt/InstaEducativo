<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Cadastro de V√≠deo - Sugest√£o Instant√¢nea</title>
  <style>
    body { font-family: Arial,sans-serif; margin:30px; background:#f4f4f9; color:#333 }
    h1 { text-align:center; margin-bottom:20px; color:#444 }
    form { max-width:600px; margin:auto; background:#fff; padding:25px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,0.1) }
    label { display:block; margin-top:15px; font-weight:bold }
    input[type="text"], textarea, select { width:100%; padding:8px 10px; margin-top:5px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box }
    textarea { resize:vertical }
    button { margin-top:20px; padding:10px 20px; border:none; background:#4CAF50; color:white; border-radius:6px; cursor:pointer; font-size:16px }
    button:hover { background:#45a049 }
    #novoAutorBtn { background:#2196F3 }
    #novoAutorBtn:hover { background:#1976D2 }
    .suggestions { border:1px solid #ccc; border-radius:6px; margin-top:2px; max-height:120px; overflow-y:auto; background:#fff; position:absolute; width:calc(100% - 20px); z-index:10 }
    .suggestions div { padding:6px 10px; cursor:pointer }
    .suggestions div:hover { background:#f0f0f0 }
    .tag-wrapper { position:relative }
  </style>
</head>
<body>
  <h1>Cadastro de V√≠deo</h1>
  <form id="formVideo">
    <label for="titulo">T√≠tulo:</label>
    <input type="text" id="titulo" name="titulo" required>

    <label for="videoId">ID do v√≠deo do YouTube:</label>
    <input type="text" id="videoId" name="videoId" required>

    <label for="descricao">Descri√ß√£o:</label>
    <textarea id="descricao" name="descricao" rows="3"></textarea>

    <label for="tags">Tags (use "." para separar n√≠veis, ex: Verbos.Have.SimplePresente):</label>
    <div class="tag-wrapper">
      <input type="text" id="tags" name="tags" autocomplete="off">
      <div id="suggestions" class="suggestions" style="display:none;"></div>
    </div>

    <label for="autor">Autor:</label>
    <select id="autor" name="autor"></select>
    <button type="button" id="novoAutorBtn">Cadastrar novo autor</button>

    <label for="numeroVideo">N√∫mero do v√≠deo:</label>
    <input type="text" id="numeroVideo" name="numeroVideo">

    <label>
      <input type="checkbox" id="especial" name="especial"> V√≠deo Especial (do dia)
    </label>

    <button type="submit">Cadastrar V√≠deo</button>
  </form>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

  <script>
  // üîπ Configura√ß√£o Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyA9r7AfToG9msI_guh8xY_PJBJXfrF_IPc",
    authDomain: "instagraneducativo.firebaseapp.com",
    projectId: "instagraneducativo",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  const form = document.getElementById("formVideo");
  const tagsInput = document.getElementById("tags");
  const autorSelect = document.getElementById("autor");
  const novoAutorBtn = document.getElementById("novoAutorBtn");
  const suggestionsDiv = document.getElementById("suggestions");

  // üîπ Conjunto de tags em mem√≥ria
  const tagsSet = new Set();

  async function ensureAuth() {
    if (!auth.currentUser) await auth.signInAnonymously();
  }

  // üîπ Carregar autores
  async function carregarAutores() {
    await ensureAuth();
    autorSelect.innerHTML = "";
    const snapshot = await db.collection("autores").get();
    snapshot.forEach(doc => {
      const opt = document.createElement("option");
      opt.value = doc.id;
      opt.textContent = doc.data().nome;
      autorSelect.appendChild(opt);
    });
  }

  novoAutorBtn.addEventListener("click", async () => {
    const nome = prompt("Digite o nome do novo autor:");
    if (!nome) return;
    const docRef = await db.collection("autores").add({ nome });
    await carregarAutores();
    autorSelect.value = docRef.id;
  });

  // üîπ Carregar todas as tags para mem√≥ria
  async function carregarTags() {
    await ensureAuth();
    const snapshot = await db.collection("tags").get();
    snapshot.forEach(doc => {
      const t = doc.data().nome.trim();
      if (t) tagsSet.add(t);
    });
    console.log("‚úÖ Tags carregadas em mem√≥ria:", Array.from(tagsSet));
  }

  // üîπ Mostrar sugest√µes instant√¢neas
  function mostrarSugestoes() {
    const value = tagsInput.value;
    const parts = value.split(".");
    const current = parts[parts.length - 1].trim().toLowerCase();

    if (!current) { suggestionsDiv.style.display = "none"; return; }

    const sugestoes = Array.from(tagsSet).filter(t => t.toLowerCase().startsWith(current));
    if (sugestoes.length === 0) { suggestionsDiv.style.display="none"; return; }

    suggestionsDiv.innerHTML = "";
    sugestoes.forEach(tag => {
      const div = document.createElement("div");
      div.textContent = tag;
      div.onclick = () => {
        parts[parts.length - 1] = tag;
        tagsInput.value = parts.join(".") + ".";
        tagsInput.focus();
        suggestionsDiv.style.display = "none";
      };
      suggestionsDiv.appendChild(div);
    });
    suggestionsDiv.style.display = "block";
  }

  tagsInput.addEventListener("input", mostrarSugestoes);
  tagsInput.addEventListener("blur", () => { setTimeout(()=>{ suggestionsDiv.style.display="none"; }, 150); });

  // üîπ Salvar v√≠deo
  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    await ensureAuth();

    const titulo = form.titulo.value;
    const videoId = form.videoId.value;
    const descricao = form.descricao.value;
    const tags = form.tags.value.split(".").map(t=>t.trim()).filter(t=>t!=="");
    const autor = form.autor.value;
    const numeroVideo = form.numeroVideo.value;
    const especial = form.especial.checked;

    try {
      // Salvar v√≠deo
      await db.collection("videos").add({
        titulo, videoId, descricao, tags, autor, numeroVideo, especial,
        data: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Atualizar tags em mem√≥ria e Firestore
      for (let t of tags) {
        if (!tagsSet.has(t)) {
          tagsSet.add(t);
          await db.collection("tags").add({ nome: t });
        }
      }

      alert("V√≠deo cadastrado com sucesso!");
      form.reset();
    } catch(err) {
      console.error("Erro ao cadastrar v√≠deo:", err);
      alert("Erro ao cadastrar v√≠deo. Veja o console.");
    }
  });

  // üîπ Inicializa√ß√£o
  (async function init() {
    await carregarAutores();
    await carregarTags();
  })();
  </script>
</body>
</html>
